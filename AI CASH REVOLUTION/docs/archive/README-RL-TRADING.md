# Real RL Inference System for Trading

A comprehensive Reinforcement Learning (RL) trading system that loads and uses pretrained PPO/CPPO models for automated cryptocurrency trading decisions. Built with TypeScript and integrated with the existing AI Cash Evolution trading platform.

## üöÄ Features

### Core Capabilities
- **Model Loading**: Load pretrained PPO/CPPO model weights from Supabase Storage
- **Version Control**: Handle model versioning and validation with checksum verification
- **Performance Caching**: Implement caching for performance optimization
- **Graceful Fallback**: Fallback to default models if specific models are unavailable
- **Real-time Inference**: Low-latency predictions with state monitoring
- **Uncertainty Quantification**: Comprehensive uncertainty estimation for reliable decisions
- **Constraint Checking**: Risk management and trading constraint validation

### Technical Features
- **FinRL Integration**: Based on FinRL patterns with LLM-infused reinforcement learning
- **PPO/CPPO Support**: Support for both Proximal Policy Optimization and Constrained PPO
- **Feature Engineering**: Integration with Unified Feature Engineering system
- **Action Space**: Trading decisions (buy/sell/hold) with intensity and confidence
- **State Representation**: Market features for comprehensive decision making
- **Error Handling**: Comprehensive error handling and monitoring
- **Performance Tracking**: Model performance metrics and statistics
- **Version Management**: Automated model version management

## üìÅ Project Structure

```
src/
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îî‚îÄ‚îÄ rl-trading.ts                 # Comprehensive type definitions
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îî‚îÄ‚îÄ rl-trading/
‚îÇ       ‚îú‚îÄ‚îÄ RLModelArchitecture.ts    # Core PPO/CPPO model implementation
‚îÇ       ‚îú‚îÄ‚îÄ ModelLoader.ts           # Model loading and validation system
‚îÇ       ‚îú‚îÄ‚îÄ InferenceEngine.ts       # Real-time inference engine
‚îÇ       ‚îî‚îÄ‚îÄ RLTradingService.ts      # Main service orchestrator
‚îú‚îÄ‚îÄ hooks/
‚îÇ   ‚îî‚îÄ‚îÄ useRLTrading.ts              # React hook for integration
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ RLTradingPanel.tsx           # Main trading panel component
‚îÇ   ‚îî‚îÄ‚îÄ RLMonitoringDashboard.tsx    # Monitoring dashboard
‚îî‚îÄ‚îÄ integrations/
    ‚îî‚îÄ‚îÄ supabase/
        ‚îî‚îÄ‚îÄ client.ts                # Supabase client configuration

supabase/
‚îî‚îÄ‚îÄ functions/
    ‚îî‚îÄ‚îÄ rl-inference/
        ‚îî‚îÄ‚îÄ index.ts                 # Server-side RL inference endpoint
```

## üõ†Ô∏è Installation

### Prerequisites
- Node.js 18+
- TypeScript 5+
- Supabase account and project
- Existing AI Cash Evolution codebase

### Setup

1. **Install Dependencies**
```bash
npm install
```

2. **Configure Environment Variables**
```env
# Supabase Configuration
SUPABASE_URL=your_supabase_url
SUPABASE_ANON_KEY=your_supabase_anon_key

# RL Trading Configuration
RL_MODEL_BUCKET=rl-models
RL_MODEL_PATH=trading-models
RL_INFERENCE_TIMEOUT=5000
RL_CACHE_SIZE=10
RL_CONFIDENCE_THRESHOLD=0.6
```

3. **Database Setup**
```sql
-- Create tables for RL predictions and monitoring
CREATE TABLE rl_predictions (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  symbol TEXT NOT NULL,
  timeframe TEXT NOT NULL,
  action TEXT NOT NULL,
  intensity FLOAT NOT NULL,
  confidence FLOAT NOT NULL,
  risk_level FLOAT NOT NULL,
  expected_reward FLOAT NOT NULL,
  uncertainty FLOAT NOT NULL,
  epistemic_uncertainty FLOAT NOT NULL,
  aleatoric_uncertainty FLOAT NOT NULL,
  reasoning TEXT,
  market_price FLOAT NOT NULL,
  market_trend FLOAT NOT NULL,
  market_volatility FLOAT NOT NULL,
  position_state TEXT NOT NULL,
  portfolio_value FLOAT NOT NULL,
  portfolio_risk FLOAT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create indexes for performance
CREATE INDEX idx_rl_predictions_timestamp ON rl_predictions(timestamp);
CREATE INDEX idx_rl_predictions_symbol ON rl_predictions(symbol);
CREATE INDEX idx_rl_predictions_timeframe ON rl_predictions(timeframe);

-- Create table for model performance tracking
CREATE TABLE rl_model_performance (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  model_id TEXT NOT NULL,
  version TEXT NOT NULL,
  timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  total_returns FLOAT NOT NULL,
  sharpe_ratio FLOAT NOT NULL,
  win_rate FLOAT NOT NULL,
  max_drawdown FLOAT NOT NULL,
  trade_count INTEGER NOT NULL,
  average_trade FLOAT NOT NULL,
  is_active BOOLEAN DEFAULT true,
  metadata JSONB
);

-- Create table for system health monitoring
CREATE TABLE rl_system_health (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  service_status TEXT NOT NULL,
  models_loaded INTEGER NOT NULL,
  cache_hit_rate FLOAT NOT NULL,
  prediction_count INTEGER NOT NULL,
  error_count INTEGER NOT NULL,
  average_confidence FLOAT NOT NULL,
  average_processing_time FLOAT NOT NULL,
  memory_usage BIGINT NOT NULL,
  health_score FLOAT NOT NULL,
  alerts JSONB
);
```

4. **Deploy Edge Functions**
```bash
# Deploy the RL inference edge function
supabase functions deploy rl-inference
```

## üöÄ Usage

### Basic Usage

```typescript
import { RLTradingService, DEFAULT_RL_CONFIG } from './src/lib/rl-trading';

// Initialize the RL trading service
const config = {
  ...DEFAULT_RL_CONFIG,
  environment: {
    ...DEFAULT_RL_CONFIG.environment,
    symbol: 'BTC/USD',
    timeframe: '1h'
  }
};

const rlService = new RLTradingService(config);

// Initialize and start the service
await rlService.initialize();
await rlService.start();

// Make predictions
const marketData = {
  symbol: 'BTC/USD',
  timeframe: '1h',
  price: 45000,
  volume: 1000000,
  volatility: 0.02,
  trend: 0.1,
  sentiment: 0.7,
  regime: {
    trendDirection: 'moderate_up',
    volatilityState: 'normal',
    momentumState: 'accelerating'
  }
};

const prediction = await rlService.predictTradingAction(marketData);
console.log('Trading Action:', prediction.action);
```

### React Integration

```typescript
import { useRLTrading } from './src/hooks/useRLTrading';

function TradingComponent() {
  const {
    isActive,
    lastAction,
    uncertainty,
    stats,
    start,
    stop,
    predict
  } = useRLTrading({
    symbol: 'BTC/USD',
    timeframe: '1h',
    autoStart: true,
    onPrediction: (action, stats) => {
      console.log('New prediction:', action);
    }
  });

  return (
    <div>
      <button onClick={isActive ? stop : start}>
        {isActive ? 'Stop' : 'Start'} RL Trading
      </button>

      {lastAction && (
        <div>
          <h3>Last Action: {lastAction.direction}</h3>
          <p>Confidence: {(lastAction.confidence * 100).toFixed(1)}%</p>
          <p>Risk Level: {(lastAction.riskLevel * 100).toFixed(1)}%</p>
        </div>
      )}
    </div>
  );
}
```

### Component Usage

```typescript
import { RLTradingPanel } from './src/components/RLTradingPanel';

function App() {
  return (
    <RLTradingPanel
      symbol="BTC/USD"
      timeframe="1h"
      marketData={marketData}
      onAction={(data) => {
        console.log('Trading action:', data);
      }}
    />
  );
}
```

## üèóÔ∏è Architecture

### Core Components

#### 1. RLModelArchitecture
- **Purpose**: Implements PPO and CPPO algorithms
- **Features**:
  - Neural network architecture with policy and value networks
  - Constraint network for CPPO
  - Uncertainty quantification
  - Model health monitoring

#### 2. ModelLoader
- **Purpose**: Handles model loading from Supabase Storage
- **Features**:
  - Version control and validation
  - Checksum verification
  - Caching system
  - Fallback mechanisms

#### 3. InferenceEngine
- **Purpose**: Real-time inference engine
- **Features**:
  - Low-latency predictions
  - Feature vector generation
  - Constraint checking
  - Performance monitoring

#### 4. RLTradingService
- **Purpose**: Main orchestrator
- **Features**:
  - Service lifecycle management
  - Integration with existing systems
  - Performance tracking
  - Error handling

### Data Flow

1. **Market Data Input** ‚Üí Feature Engineering ‚Üí Feature Vector
2. **Feature Vector** ‚Üí Model Loading ‚Üí Inference Engine
3. **Inference Engine** ‚Üí PPO/CPPO Model ‚Üí Trading Action
4. **Trading Action** ‚Üí Constraint Checking ‚Üí Final Decision
5. **Final Decision** ‚Üí Monitoring & Logging ‚Üí Performance Tracking

## üîß Configuration

### Model Configuration

```typescript
const modelConfig = {
  modelType: 'PPO' | 'CPPO',
  stateDim: 128,                    // State vector dimension
  actionDim: 3,                     // Number of actions (BUY, SELL, HOLD)
  hiddenLayers: [128, 64, 32],      // Neural network architecture
  learningRate: 0.001,
  gamma: 0.99,                      // Discount factor
  clipRatio: 0.2,                   // PPO clipping parameter
  entropyCoeff: 0.01,               // Entropy coefficient
  valueCoeff: 0.5,                  // Value loss coefficient
  maxGradNorm: 0.5,                 // Gradient clipping
  batchSize: 32,
  epochs: 10
};
```

### Inference Configuration

```typescript
const inferenceConfig = {
  modelPath: 'BTC/USD/ppo-model',
  cacheSize: 10,                    // Number of models to cache
  cacheTTL: 1800000,                // Cache time-to-live (30 minutes)
  inferenceTimeout: 5000,           // Maximum inference time
  enableFallback: true,             // Enable fallback to default model
  fallbackModel: 'default/ppo-model',
  enableMonitoring: true,          // Enable performance monitoring
  enableUncertaintyQuantification: true,
  confidenceThreshold: 0.6,         // Minimum confidence threshold
  maxInferenceMemory: 100 * 1024 * 1024,  // 100MB memory limit
  enableCompression: true           // Enable model compression
};
```

### Environment Configuration

```typescript
const environmentConfig = {
  symbol: 'BTC/USD',
  timeframe: '1h',
  initialBalance: 10000,
  leverage: 1,
  riskPerTrade: 0.02,
  maxDailyLoss: 0.1,
  maxPositionSize: 0.1,
  tradingHours: {
    start: '00:00',
    end: '23:59',
    timezone: 'UTC'
  },
  allowedDays: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'],
  constraints: {
    maxLeverage: 10,
    maxDrawdown: 0.2,
    maxConcurrentTrades: 3,
    minTradeInterval: 300  // 5 minutes
  }
};
```

## üìä Monitoring

### Performance Metrics

The system tracks various performance metrics:

- **Prediction Accuracy**: Model confidence and success rate
- **Processing Time**: Inference latency and performance
- **Cache Performance**: Hit rates and memory usage
- **Trading Performance**: Returns, Sharpe ratio, win rate
- **Model Health**: Version status and integrity
- **Error Rates**: System reliability and error tracking

### Monitoring Dashboard

Use the `RLMonitoringDashboard` component for real-time monitoring:

```typescript
import { RLMonitoringDashboard } from './src/components/RLMonitoringDashboard';

<RLMonitoringDashboard
  service={rlService}
  autoRefresh={true}
  refreshInterval={5000}
/>
```

### Key Monitoring Endpoints

- **Service Health**: `/api/rl/health`
- **Model Status**: `/api/rl/models`
- **Performance Metrics**: `/api/rl/performance`
- **Recent Predictions**: `/api/rl/predictions`

## üîí Security

### Model Security
- **Checksum Verification**: All models are validated with checksums
- **Version Control**: Model versions are tracked and validated
- **Access Control**: Supabase RLS policies for model access
- **Encryption**: Models are stored encrypted in Supabase

### Trading Security
- **Risk Limits**: Position size and leverage constraints
- **Circuit Breakers**: Automatic trading halt on high volatility
- **Time Restrictions**: Trading hours and session limits
- **Portfolio Limits**: Maximum exposure and drawdown limits

### Data Security
- **API Authentication**: JWT-based authentication
- **Rate Limiting**: API rate limiting to prevent abuse
- **Data Validation**: Input validation and sanitization
- **Audit Logging**: Comprehensive logging of all actions

## üöÄ Deployment

### Development Deployment

```bash
# Install dependencies
npm install

# Start development server
npm run dev

# Run tests
npm test

# Build for development
npm run build:dev
```

### Production Deployment

```bash
# Build for production
npm run build

# Run production build
npm run preview

# Deploy edge functions
supabase functions deploy rl-inference

# Deploy database migrations
supabase db push
```

### Docker Deployment

```dockerfile
FROM node:18-alpine

WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

EXPOSE 3000
CMD ["npm", "start"]
```

### Cloud Deployment

#### Vercel Deployment
```yaml
# vercel.json
{
  "builds": [
    {
      "src": "src/**/*",
      "use": "@vercel/next"
    }
  ],
  "env": {
    "SUPABASE_URL": "@supabase_url",
    "SUPABASE_ANON_KEY": "@supabase_anon_key"
  }
}
```

#### AWS Deployment
```yaml
# aws-cloudformation.yml
Resources:
  RLTradingService:
    Type: AWS::ECS::Service
    Properties:
      TaskDefinition: !Ref RLTaskDefinition
      DesiredCount: 2
      LaunchType: FARGATE
```

## üß™ Testing

### Unit Tests

```typescript
import { RLModelArchitecture } from './src/lib/rl-trading/RLModelArchitecture';

describe('RLModelArchitecture', () => {
  let model: RLModelArchitecture;

  beforeEach(() => {
    const config = {
      modelType: 'PPO',
      stateDim: 10,
      actionDim: 3,
      hiddenLayers: [8, 4],
      learningRate: 0.001,
      gamma: 0.99,
      clipRatio: 0.2,
      entropyCoeff: 0.01,
      valueCoeff: 0.5,
      maxGradNorm: 0.5,
      batchSize: 32,
      epochs: 10
    };
    model = new RLModelArchitecture(config);
  });

  test('should initialize model correctly', () => {
    expect(model).toBeDefined();
  });

  test('should make predictions', () => {
    const state = Array(10).fill(0.1);
    const prediction = model.selectAction(state, false);
    expect(prediction.action).toBeGreaterThanOrEqual(0);
    expect(prediction.action).toBeLessThan(3);
  });
});
```

### Integration Tests

```typescript
import { RLTradingService } from './src/lib/rl-trading/RLTradingService';

describe('RLTradingService Integration', () => {
  let service: RLTradingService;

  beforeEach(async () => {
    const config = { ...DEFAULT_RL_CONFIG };
    service = new RLTradingService(config);
    await service.initialize();
  });

  test('should start and stop service', async () => {
    await service.start();
    expect(service.getServiceStatus().isActive).toBe(true);

    await service.stop();
    expect(service.getServiceStatus().isActive).toBe(false);
  });

  test('should make predictions', async () => {
    await service.start();

    const marketData = {
      symbol: 'BTC/USD',
      timeframe: '1h',
      price: 45000,
      volume: 1000000,
      volatility: 0.02,
      trend: 0.1
    };

    const prediction = await service.predictTradingAction(marketData);
    expect(prediction.action).toBeDefined();
    expect(prediction.confidence).toBeGreaterThan(0);
  });
});
```

### E2E Tests

```typescript
describe('RL Trading E2E', () => {
  test('should complete full trading cycle', async () => {
    // Start service
    // Load market data
    // Make predictions
    // Verify constraints
    // Log predictions
    // Stop service
  });
});
```

## üìà Performance Optimization

### Model Optimization
- **Model Compression**: Reduce model size for faster loading
- **Quantization**: Use quantized models for faster inference
- **Batch Processing**: Process multiple predictions in batches
- **GPU Acceleration**: Use GPU acceleration for matrix operations

### Cache Optimization
- **Intelligent Caching**: Cache frequently used models
- **Memory Management**: Optimize memory usage for large models
- **Cache Warming**: Preload models during startup
- **Cache Eviction**: Implement LRU cache eviction

### Network Optimization
- **CDN Distribution**: Distribute models via CDN
- **Compression**: Compress model transfers
- **Connection Pooling**: Pool database connections
- **Lazy Loading**: Load models on-demand

## üêõ Debugging

### Common Issues

#### Model Loading Issues
```typescript
// Check model availability
const modelVersions = await modelLoader.listModelVersions('BTC/USD');
console.log('Available versions:', modelVersions);

// Verify model integrity
const integrity = await modelLoader.verifyModelIntegrity('BTC/USD', 'latest');
console.log('Model integrity:', integrity);
```

#### Performance Issues
```typescript
// Check cache performance
const cacheStats = modelLoader.getCacheStats();
console.log('Cache stats:', cacheStats);

// Check inference performance
const engineStats = inferenceEngine.getEngineStats();
console.log('Engine stats:', engineStats);
```

#### Prediction Issues
```typescript
// Enable debug logging
const debugConfig = {
  ...config,
  monitoring: {
    ...config.monitoring,
    enableCustomMetrics: true,
    metricsInterval: 1000
  }
};
```

### Debug Tools

1. **Browser DevTools**: Monitor network requests and performance
2. **Console Logging**: Enable verbose logging
3. **Performance Monitoring**: Use monitoring dashboard
4. **Database Logs**: Check Supabase logs
5. **Edge Function Logs**: Check function logs

## üìö Documentation

### API Documentation

#### RLTradingService

```typescript
class RLTradingService {
  constructor(config: RLAgentConfig);
  initialize(): Promise<void>;
  start(): Promise<void>;
  stop(): void;
  predictTradingAction(marketData: any): Promise<PredictionResult>;
  getServiceStatus(): ServiceStatus;
  getDetailedStats(): DetailedStats;
  reset(): Promise<void>;
}
```

#### PredictionResult

```typescript
interface PredictionResult {
  action: RLAction;
  uncertainty: UncertaintyEstimate;
  constraints: ConstraintViolation[];
  processingTime: number;
}
```

#### RLAction

```typescript
interface RLAction {
  direction: 'BUY' | 'SELL' | 'HOLD';
  intensity: number;           // 0-1
  confidence: number;         // 0-1
  riskLevel: number;          // 0-1
  expectedReward: number;
  stopLoss?: number;
  takeProfit?: number;
  reasoning?: string;
}
```

## ü§ù Contributing

### Development Workflow

1. **Fork the repository**
2. **Create feature branch**: `git checkout -b feature/new-feature`
3. **Make changes and tests**
4. **Run tests**: `npm test`
5. **Build project**: `npm run build`
6. **Commit changes**: `git commit -m "Add new feature"`
7. **Push to branch**: `git push origin feature/new-feature`
8. **Create Pull Request**

### Code Standards

- **TypeScript**: Use strict TypeScript mode
- **ESLint**: Follow ESLint configuration
- **Prettier**: Use Prettier for code formatting
- **Testing**: Maintain test coverage above 80%
- **Documentation**: Document all public APIs

## üìÑ License

This project is licensed under the MIT License - see the LICENSE file for details.

## üôè Acknowledgments

- **FinRL**: For the RL trading framework inspiration
- **Supabase**: For the excellent backend services
- **Vite**: For the fast development environment
- **React**: For the user interface framework
- **TypeScript**: For type safety and developer experience

## üìû Support

For support, please:
1. Check the documentation
2. Search existing issues
3. Create a new issue with detailed information
4. Join our community discussions

---

**Note**: This is a sophisticated trading system that involves real financial risks. Always thoroughly test and validate models before using them in live trading environments.